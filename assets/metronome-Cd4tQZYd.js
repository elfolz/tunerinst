import{_ as x,a as w,r as d,b as M,o as m,c as k,d as n,w as u,e as o,n as T,f as g,g as c,t as h,h as v,i as L,F as I,j as R,p as _,k as D}from"./index-BlmGDnBs.js";const Y=[{name:"Gravissimo",bpm:10},{name:"Grave",bpm:20},{name:"Larghissimo",bpm:30},{name:"Largo",bpm:40},{name:"Larghetto",bpm:50},{name:"Adagio",bpm:60},{name:"Adagietto",bpm:70},{name:"Andante",bpm:80},{name:"Andantino",bpm:90},{name:"Moderato",bpm:100},{name:"Allegretto",bpm:110},{name:"Allegro moderato",bpm:120},{name:"Allegro ma non troppo",bpm:130},{name:"Allegro",bpm:140},{name:"Vivace",bpm:150},{name:"Vivacissimo",bpm:160},{name:"Alegricissimo",bpm:170},{name:"Presto",bpm:180},{name:"Presto vivace",bpm:190},{name:"Prestissimo",bpm:200}],E={name:"metronome",computed:{baseUrl(){return"/"},darkTheme(){return this.$vuetify.theme.current.dark},inputDevices(){return this.$store.state.inputDevices},outputDevices(){return this.$store.state.outputDevices},tempos(){return Y},bpm:{get(){return this.tempo?this.tempo*parseInt(this.speed)/100:this.srcTrack?this.$store.state.metronomeBPM*parseInt(this.speed)/100:this.$store.state.metronomeBPM},set(e){this.$store.dispatch("setMetronomeBPM",e)}},bpmStep:{get(){return this.$store.state.metronomeBPMStep},set(e){this.$store.dispatch("setMetronomeBPMStep",e)}},autoBPM(){return!!this.tempo},youtubeEnabled(){return this.playing!=null||!this.youtubeLink?!0:this.youtubeReady}},data(){return{reader:new FileReader,audio:new Audio,audioCtx:null,destination:null,envelope:null,tick:null,playing:null,rhythm:1,index:0,tic:null,toc:null,buttons:[],srcTrack:null,srcTrackBuffer:null,strTrackTitle:null,bufferSize:512,tempo:null,loadingTempo:!1,youtubePlayer:null,youtubeReady:!1,youtubeLink:null,delay:0,speed:100}},created(){this.buttons=[{strokes:1,icon:`${this.baseUrl}img/note-seminima`},{strokes:2,icon:`${this.baseUrl}img/note-colcheia`},{strokes:3,icon:`${this.baseUrl}img/note-tercina`},{strokes:4,icon:`${this.baseUrl}img/note-semi-colcheia`}]},mounted(){window.addEventListener("keydown",this.toggleByKeyboard),this.loadYoutubeApi(),this.loadSrcAudioElement(),this.reader.onload=e=>{e.target.result&&(this.srcTrackBuffer=e.target.result)}},beforeUnmount(){this.playing!==null&&(this.audio.pause(),this.audioCtx.close()),window.removeEventListener("keydown",this.toggleByKeyboard)},methods:{toggleByKeyboard(e){if(document.hidden)return!1;(e.code=="Digit1"||e.code=="Numpad1")&&this.toggle(1,0),(e.code=="Digit2"||e.code=="Numpad2")&&this.toggle(2,1),(e.code=="Digit3"||e.code=="Numpad3")&&this.toggle(3,2),(e.code=="Digit4"||e.code=="Numpad4")&&this.toggle(4,3),["ArrowLeft","MediaTrackPrevious","-"].includes(e.key)&&this.subtractBpm(),["ArrowRight","MediaTrackNext","+"].includes(e.key)&&this.addBpm(),[" ","MediaPlayPause"].includes(e.key)&&(this.toggle(this.rhythm,this.index),e.preventDefault()),e.code=="Escape"&&this.stop()},toggle(e,t,r=!1){var a,i;if(this.playing!==null&&((a=this.youtubePlayer)==null||a.stopVideo(),this.audio.pause(),this.audioCtx.close()),!(r&&this.playing==null)){if(!r&&this.playing==t)return this.audio.pause(),(i=this.youtubePlayer)==null||i.stopVideo(),this.playing=null;this.rhythm=e,this.index=t,this.playing=t,document.documentElement.style.setProperty("--tempo",`${12e4/this.bpm}ms`),this.createAudioCtx()}},createAudioCtx(){this.audioCtx=new AudioContext,this.destination=this.audioCtx.createMediaStreamDestination(),this.envelope=this.audioCtx.createGain(),this.envelope.connect(this.destination),this.audio.srcObject=this.destination.stream,this.$store.state.defaultOutputId&&this.outputDevices.find(e=>e.deviceId==this.$store.state.defaultOutputId)&&this.audio.setSinkId(this.$store.state.defaultOutputId),this.createTicks()},createTicks(){this.tick=this.audioCtx.createOscillator(),this.tick.type="sine",this.tick.connect(this.envelope);let e=this.audioCtx.currentTime;for(let t=0;t<1e4;t++)this.tick.frequency.setValueAtTime(this.getSound(t%this.rhythm),e),this.envelope.gain.setValueAtTime(0,e),this.envelope.gain.linearRampToValueAtTime(0,e+.001+.01),this.envelope.gain.linearRampToValueAtTime(1,e+.001),e+=60/(this.bpm*this.rhythm);this.srcTrackBuffer?this.playSrcTrack():this.play()},playSrcTrack(){this.srcTrackBuffer&&(this.envelope2=this.audioCtx.createGain(),this.envelope2.connect(this.destination),this.envelope2.gain.value=.35,this.audioCtx.decodeAudioData(this.srcTrackBuffer.slice(0)).then(e=>{this.srcTrack=this.audioCtx.createBufferSource(),this.srcTrack.buffer=e,this.srcTrack.loop=!0,this.srcTrack.connect(this.envelope2),this.play()}))},play(){var r,a;this.youtubeLink&&((r=this.youtubePlayer)==null||r.playVideo());const e=parseFloat(this.delay/60);this.audio.play();try{this.tick.start(e,e)}catch{}const t=parseInt(this.speed)/100;this.srcTrack&&(this.srcTrack.start(60/(this.bpm*this.rhythm)),this.srcTrack.playbackRate.value=t,this.srcTrack.detune.value=t),(a=this.youtubePlayer)==null||a.setPlaybackRate(t)},stop(){var e;(e=this.youtubePlayer)==null||e.stopVideo(),this.playing&&this.audioCtx.close(),this.audio.pause(),this.playing=null},getSound(e,t=!1){return this.rhythm<=1?1500:this.rhythm%2==0?e%2==0?1500:1e3:e==0?1500:1e3},subtractBpm(){if(this.$refs.subtractBpmButton.$el.blur(),this.bpm<=this.bpmStep)return!1;this.bpm-=this.bpmStep,this.playing!==null&&this.toggle(this.rhythm,this.index,!0)},addBpm(){if(this.$refs.addBpmButton.$el.blur(),this.bpm>=200)return!1;this.bpm+=this.bpmStep,this.playing!==null&&this.toggle(this.rhythm,this.index,!0)},loadYoutubeApi(){const e=document.createElement("script");e.src="https://www.youtube.com/iframe_api",this.$el.append(e),window.onYouTubeIframeAPIReady=()=>{this.youtubePlayer=new YT.Player("player",{with:"320",height:"240",events:{onReady:this.onYoutubePlayerReady,onError:this.onYoutubePlayerError,onStateChange:this.onYoutubePlayerStateChange}})}},loadSrcAudioElement(){if(!this.$refs.srcTrack)return setTimeout(()=>this.loadSrcAudioElement(),100);this.$refs.srcTrack.onchange=e=>{this.stop();const t=e.target.files[0];if(this.loadingTempo=!1,this.tempo=null,!t){this.speed=100,this.srcTrack=null,this.strTrackTitle=null,this.srcTrackBuffer=null;return}this.strTrackTitle=t.name.replace(/_-/," "),this.reader.readAsArrayBuffer(t)}},calcBPM(){if(!this.srcTrackBuffer)return;this.stop(),this.tempo=null,this.loadingTempo=!0,this.audioCtx=new AudioContext;const e=this.audioCtx.createScriptProcessor(this.bufferSize,1,1),t=this.audioCtx.createGain();t.gain.value=0,t.connect(this.audioCtx.destination),e.connect(t),this.audioCtx.decodeAudioData(this.srcTrackBuffer.slice(0)).then(r=>{this.srcTrack=this.audioCtx.createBufferSource(),this.srcTrack.buffer=r,this.srcTrack.connect(e),this.srcTrack.connect(t),w().then(({Tempo:a})=>{const i=new a(e.bufferSize*4,e.bufferSize,this.audioCtx.sampleRate);e.onaudioprocess=l=>{let b=i.do(l.inputBuffer.getChannelData(0)),p=i.getBpm();b&&(this.tempo=parseInt(p))},this.srcTrack.start(10,0,5),this.srcTrack.onended=()=>{this.audioCtx.close(),this.loadingTempo=!1}})})},toggleAutoBPM(){this.tempo?this.tempo=null:this.calcBPM()},onYoutubePlayerReady(){this.youtubeReady=!0},onYoutubePlayerError(e){this.youtubeReady=!1},onYoutubePlayerStateChange(e){this.youtubeReady=e.data==5},pasteYoutubeLink(){this.youtubeReady=!1,navigator.clipboard.readText().then(e=>{e&&(this.youtubeLink=e,this.refreshYoutubeLink())})},refreshYoutubeLink(){var a,i;if(this.stop(),!this.youtubeLink)return;this.youtubeReady=!1;const e=new URL(this.youtubeLink),t=e.searchParams.get("v")??e.pathname.replace("/",""),r=parseInt(e.searchParams.get("t")??"0");(a=this.youtubePlayer)==null||a.cueVideoById(t,r),(i=this.youtubePlayer)==null||i.setVolume(50)}}},B=e=>(_("data-v-f2d4a04a"),e=e(),D(),e),U=B(()=>o("div",{id:"player"},null,-1)),N=B(()=>o("figure",null,null,-1)),z={type:"file",id:"srcTrack",ref:"srcTrack",accept:"audio/*,video/*"},F=["src"];function G(e,t,r,a,i,l){const b=d("v-select"),p=d("v-slider"),P=d("v-progress-linear"),y=d("v-btn"),C=d("v-icon"),V=d("v-text-field"),S=d("v-main"),A=M("ripple");return m(),k("main",null,[n(S,null,{default:u(()=>[U,o("section",null,[N,o("mark",{class:T({animating:i.playing!=null})},null,2)]),o("section",null,[o("header",null,[n(b,{modelValue:l.bpm,"onUpdate:modelValue":t[0]||(t[0]=s=>l.bpm=s),items:l.tempos,"item-title":"name","item-value":"bpm",label:e.$t("metronome.tempo"),disabled:i.loadingTempo||l.autoBPM},null,8,["modelValue","items","label","disabled"]),!i.loadingTempo&&!i.tempo?(m(),g(p,{key:0,"hide-details":"",modelValue:l.bpm,"onUpdate:modelValue":[t[1]||(t[1]=s=>l.bpm=s),t[2]||(t[2]=s=>l.toggle(i.rhythm,i.index,!0))],step:"5",max:"200","thumb-label":"always",color:"primary"},{"thumb-label":u(({modelValue:s})=>[c(h(`${s} ${e.$t("drums.bpm")}`),1)]),_:1},8,["modelValue"])):v("",!0),!i.loadingTempo&&i.tempo?(m(),g(p,{key:1,"hide-details":"",readonly:"",modelValue:i.tempo,"onUpdate:modelValue":[t[3]||(t[3]=s=>i.tempo=s),t[4]||(t[4]=s=>l.toggle(i.rhythm,i.index,!0))],step:"1",max:"250","thumb-label":"always"},{"thumb-label":u(({modelValue:s})=>[c(h(`${s} ${e.$t("drums.bpm")}`),1)]),_:1},8,["modelValue"])):v("",!0),i.loadingTempo?(m(),g(P,{key:2,indeterminate:""})):v("",!0)]),o("article",null,[n(y,{onClick:l.subtractBpm,ref:"subtractBpmButton",icon:"remove",size:"small",disabled:i.loadingTempo||l.autoBPM,title:e.$t("metronome.subtractStep",{n:l.bpmStep})},null,8,["onClick","disabled","title"]),n(b,{variant:"underlined",modelValue:l.bpmStep,"onUpdate:modelValue":t[5]||(t[5]=s=>l.bpmStep=s),items:l.tempos,"item-title":"bpm",disabled:i.loadingTempo||l.autoBPM,"item-value":"bpm"},null,8,["modelValue","items","disabled"]),n(y,{fab:"",small:"",onClick:l.addBpm,ref:"addBpmButton",icon:"add",size:"small",disabled:i.loadingTempo||l.autoBPM,title:e.$t("metronome.addStep",{n:l.bpmStep})},null,8,["onClick","disabled","title"])]),o("nav",null,[o("div",null,[o("input",z,null,512),L((m(),k("label",{for:"srcTrack",class:T(["v-btn v-btn--elevated v-btn--density-default v-btn--size-default v-btn--variant-elevated elevation-4",{"bg-accent":!!i.strTrackTitle,"v-btn--disabled":i.playing!=null||i.loadingTempo}])},[o("span",null,h(i.strTrackTitle??e.$t("metronome.srcTrack")),1)],2)),[[A]]),n(y,{loading:i.loadingTempo,disabled:i.playing!=null||!i.strTrackTitle,onClick:t[6]||(t[6]=s=>l.toggleAutoBPM())},{default:u(()=>[n(C,null,{default:u(()=>[c(h(l.autoBPM?"pan_tool":"speed"),1)]),_:1}),c(" "+h(l.autoBPM?e.$t("metronome.manualBpm"):e.$t("metronome.detectBpm")),1)]),_:1},8,["loading","disabled"])]),o("div",null,[n(V,{modelValue:i.youtubeLink,"onUpdate:modelValue":t[7]||(t[7]=s=>i.youtubeLink=s),label:e.$t("metronome.youtubeVideo"),"append-inner-icon":"content_paste",disabled:i.playing!=null,"onClick:appendInner":t[8]||(t[8]=s=>l.pasteYoutubeLink()),onInput:t[9]||(t[9]=s=>l.refreshYoutubeLink())},null,8,["modelValue","label","disabled"])]),o("div",null,[n(p,{"hide-details":"",modelValue:i.delay,"onUpdate:modelValue":t[10]||(t[10]=s=>i.delay=s),step:"1",max:"180","thumb-label":"always",color:"primary",disabled:i.playing!=null},{"thumb-label":u(({modelValue:s})=>[c(h(`${e.$t("metronome.delay")} ${(s/60).toFixed(2)}`)+"s",1)]),_:1},8,["modelValue","disabled"])]),o("div",null,[n(p,{"hide-details":"",modelValue:i.speed,"onUpdate:modelValue":[t[11]||(t[11]=s=>i.speed=s),t[12]||(t[12]=s=>l.toggle(i.rhythm,i.index,!0))],step:"5",max:"100","thumb-label":"always",color:"primary",disabled:!i.strTrackTitle&&!i.youtubeLink},{"thumb-label":u(({modelValue:s})=>[c(h(`${e.$t("metronome.speed")} ${s}`)+"%",1)]),_:1},8,["modelValue","disabled"])])]),o("footer",null,[(m(!0),k(I,null,R(i.buttons,(s,f)=>(m(),g(y,{key:f,onClick:O=>l.toggle(s.strokes,f),color:i.playing==f?"primary":null,class:"elevation-4",disabled:i.loadingTempo||!l.youtubeEnabled,title:e.$t("metronome.play",{n:`Numpad ${f+1}`})},{default:u(()=>[o("img",{src:`${s.icon}${l.darkTheme?"-dark":"-light"}.svg`},null,8,F)]),_:2},1032,["onClick","color","disabled","title"]))),128))])])]),_:1})])}const j=x(E,[["render",G],["__scopeId","data-v-f2d4a04a"]]);export{j as default};
