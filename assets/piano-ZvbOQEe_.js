import{_ as y,l as g,r as a,o,g as u,w as m,e as _,c as d,j as v,F as k,n as h,h as $}from"./index-DguWFXW3.js";const w={name:"piano",computed:{baseUrl(){return"/"},device(){return g()},inputDevices(){return this.$store.state.inputDevices},outputDevices(){return this.$store.state.outputDevices}},data(){return{loading:!1,audioCtx:new AudioContext,audio:new Audio,destination:null,gain:null,audioSrcs:{},buffers:{},playing:[],notes:["C4","Cs4","D4","Ds4","E4","F4","Fs4","G4","Gs4","A4","As4","B4"]}},mounted(){this.getAudios(),this.destination=this.audioCtx.createMediaStreamDestination(),this.audio.srcObject=this.destination.stream,this.$store.state.defaultOutputId&&this.outputDevices.find(t=>t.deviceId==this.$store.state.defaultOutputId)&&this.audio.setSinkId(this.$store.state.defaultOutputId),this.gain=this.audioCtx.createGain(),this.gain.gain.value=3,this.gain.connect(this.destination),window.addEventListener("keydown",this.activateKeyboard),window.addEventListener("keyup",this.stop)},beforeUnmount(){this.audio.pause(),this.audioCtx.close(),window.removeEventListener("keydown",this.activateKeyboard),window.removeEventListener("keyup",this.stop)},methods:{getAudios(){this.loading=!0;let t=[];for(let i of this.notes)t.push(fetch(`${this.baseUrl}audio/piano/${i}.${this.device.name=="ios"?"aac":"opus"}`).then(e=>e.arrayBuffer()).then(e=>({buffer:e,note:i})));Promise.all(t).then(i=>{for(let e of i){let r=e.note;this.audioCtx.decodeAudioData(e.buffer,s=>{this.buffers[r]=s})}this.listenKeys(),this.loading=!1})},play(t){if(this.audio.paused&&this.audio.play(),this.loading||this.playing.includes(t))return!1;this.audioSrcs[t]=this.audioCtx.createBufferSource(),this.audioSrcs[t].buffer=this.buffers[t],this.audioSrcs[t].connect(this.gain),this.audioSrcs[t].start(),this.audioSrcs[t].stop(this.audioCtx.currentTime+1),this.playing.push(t),this.$forceUpdate()},stop(t){let i=t.key?this.getNoteByKey(t.key):t;if(i===null)return!1;let e=t.key?this.notes[i]:t,r=this.playing.indexOf(e);this.playing.splice(r,1),delete this.audioSrcs[e],this.$forceUpdate()},activateKeyboard(t){let i=this.getNoteByKey(t.key);if(i===null)return!1;let e=this.notes[i];this.play(e)},getNoteByKey(t){return t=="a"?0:t=="w"?1:t=="s"?2:t=="e"?3:t=="d"?4:t=="f"?5:t=="t"?6:t=="g"?7:t=="y"?8:t=="h"?9:t=="u"?10:t=="j"?11:null},listenKeys(){var t;if(!((t=Object.keys(this.$refs))!=null&&t.length))return setTimeout(()=>this.listenKeys(),100);for(let i in this.$refs)this.device.isMobile?(this.$refs[i][0].ontouchstart=e=>{this.play(e.target.id)},this.$refs[i][0].ontouchend=e=>{this.stop(e.target.id)}):(this.$refs[i][0].onmousedown=e=>{this.play(e.target.id)},this.$refs[i][0].onmouseup=e=>{this.stop(e.target.id)},this.$refs[i][0].onmouseleave=e=>{this.stop(e.target.id)})},isActive(t){return this.audioSrcs[t]!=null}}},b=["id"];function C(t,i,e,r,s,c){const f=a("v-progress-linear"),l=a("v-main");return o(),u(l,null,{default:m(()=>[_("section",{class:h({loading:s.loading})},[(o(!0),d(k,null,v(s.notes,(n,p)=>(o(),d("mark",{key:p,ref_for:!0,ref:`key-${n}`,id:n,class:h({semi:n.includes("s"),active:c.isActive(n)})},null,10,b))),128))],2),s.loading?(o(),u(f,{key:0,indeterminate:""})):$("",!0)]),_:1})}const S=y(w,[["render",C],["__scopeId","data-v-38635458"]]);export{S as default};
