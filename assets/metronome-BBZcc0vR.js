import{_ as V,a as w,r as u,b as _,o as d,c as y,d as n,w as b,e as l,n as v,f,g,h as M,t as k,i as T,F as L,j as D,p as I,k as R}from"./index-DS3So9s_.js";const Y=[{name:"Gravissimo",bpm:10},{name:"Grave",bpm:20},{name:"Larghissimo",bpm:30},{name:"Largo",bpm:40},{name:"Larghetto",bpm:50},{name:"Adagio",bpm:60},{name:"Adagietto",bpm:70},{name:"Andante",bpm:80},{name:"Andantino",bpm:90},{name:"Moderato",bpm:100},{name:"Allegretto",bpm:110},{name:"Allegro moderato",bpm:120},{name:"Allegro ma non troppo",bpm:130},{name:"Allegro",bpm:140},{name:"Vivace",bpm:150},{name:"Vivacissimo",bpm:160},{name:"Alegricissimo",bpm:170},{name:"Presto",bpm:180},{name:"Presto vivace",bpm:190},{name:"Prestissimo",bpm:200}],E={name:"metronome",computed:{baseUrl(){return"/"},darkTheme(){return this.$vuetify.theme.current.dark},inputDevices(){return this.$store.state.inputDevices},outputDevices(){return this.$store.state.outputDevices},tempos(){return Y},bpm:{get(){return this.tempo||this.$store.state.metronomeBPM},set(e){this.$store.dispatch("setMetronomeBPM",e)}},bpmStep:{get(){return this.$store.state.metronomeBPMStep},set(e){this.$store.dispatch("setMetronomeBPMStep",e)}},autoBPM(){return!!this.tempo},youtubeEnabled(){return this.playing!=null||!this.youtubeLink?!0:this.youtubeReady}},data(){return{reader:new FileReader,audio:new Audio,audioCtx:null,destination:null,envelope:null,tick:null,playing:null,rhythm:1,index:0,tic:null,toc:null,buttons:[],srcTrack:null,srcTrackBuffer:null,strTrackTitle:null,bufferSize:512,tempo:null,loadingTempo:!1,youtubePlayer:null,youtubeReady:!1,youtubeLink:null}},created(){this.buttons=[{strokes:1,icon:`${this.baseUrl}img/note-seminima`},{strokes:2,icon:`${this.baseUrl}img/note-colcheia`},{strokes:3,icon:`${this.baseUrl}img/note-tercina`},{strokes:4,icon:`${this.baseUrl}img/note-semi-colcheia`}]},mounted(){window.addEventListener("keydown",this.toggleByKeyboard),this.loadYoutubeApi(),this.loadSrcAudioElement(),this.reader.onload=e=>{e.target.result&&(this.srcTrackBuffer=e.target.result)}},beforeDestroy(){this.playing!==null&&(this.audio.pause(),this.audioCtx.close()),window.removeEventListener("keydown",this.toggleByKeyboard)},methods:{toggleByKeyboard(e){if(document.hidden)return!1;(e.code=="Digit1"||e.code=="Numpad1")&&this.toggle(1,0),(e.code=="Digit2"||e.code=="Numpad2")&&this.toggle(2,1),(e.code=="Digit3"||e.code=="Numpad3")&&this.toggle(3,2),(e.code=="Digit4"||e.code=="Numpad4")&&this.toggle(4,3),["ArrowLeft","MediaTrackPrevious","-"].includes(e.key)&&this.subtractBpm(),["ArrowRight","MediaTrackNext","+"].includes(e.key)&&this.addBpm(),[" ","MediaPlayPause"].includes(e.key)&&(this.toggle(this.rhythm,this.index),e.preventDefault()),e.code=="Escape"&&this.stop()},toggle(e,t,r=!1){var a,i;if(this.playing!==null&&((a=this.youtubePlayer)==null||a.stopVideo(),this.audio.pause(),this.audioCtx.close()),!(r&&this.playing==null)){if(!r&&this.playing==t)return this.audio.pause(),(i=this.youtubePlayer)==null||i.stopVideo(),this.playing=null;this.rhythm=e,this.index=t,this.playing=t,document.documentElement.style.setProperty("--tempo",`${12e4/this.bpm}ms`),this.createAudioCtx()}},createAudioCtx(){this.audioCtx=new AudioContext,this.destination=this.audioCtx.createMediaStreamDestination(),this.envelope=this.audioCtx.createGain(),this.envelope.connect(this.destination),this.audio.srcObject=this.destination.stream,this.$store.state.defaultOutputId&&this.outputDevices.find(e=>e.deviceId==this.$store.state.defaultOutputId)&&this.audio.setSinkId(this.$store.state.defaultOutputId),this.createTicks()},createTicks(){this.tick=this.audioCtx.createOscillator(),this.tick.type="sine",this.tick.connect(this.envelope);let e=this.audioCtx.currentTime;for(let t=0;t<1e4;t++)this.tick.frequency.setValueAtTime(this.getSound(t%this.rhythm),e),this.envelope.gain.setValueAtTime(0,e),this.envelope.gain.linearRampToValueAtTime(0,e+.001+.01),this.envelope.gain.linearRampToValueAtTime(1,e+.001),e+=60/(this.bpm*this.rhythm);this.srcTrackBuffer?this.playSrcTrack():this.play()},playSrcTrack(){this.srcTrackBuffer&&(this.envelope2=this.audioCtx.createGain(),this.envelope2.connect(this.destination),this.envelope2.gain.value=.35,this.audioCtx.decodeAudioData(this.srcTrackBuffer.slice(0)).then(e=>{this.srcTrack=this.audioCtx.createBufferSource(),this.srcTrack.buffer=e,this.srcTrack.loop=!0,this.srcTrack.connect(this.envelope2),this.play()}))},play(){var e,t;this.youtubeLink&&((e=this.youtubePlayer)==null||e.playVideo()),this.audio.play(),this.tick.start(),(t=this.srcTrack)==null||t.start(60/(this.bpm*this.rhythm))},stop(){var e;(e=this.youtubePlayer)==null||e.stopVideo(),this.playing&&this.audioCtx.close(),this.audio.pause(),this.playing=null},getSound(e,t=!1){return this.rhythm<=1?1500:this.rhythm%2==0?e%2==0?1500:1e3:e==0?1500:1e3},subtractBpm(){if(this.$refs.subtractBpmButton.$el.blur(),this.bpm<=this.bpmStep)return!1;this.bpm-=this.bpmStep,this.playing!==null&&this.toggle(this.rhythm,this.index,!0)},addBpm(){if(this.$refs.addBpmButton.$el.blur(),this.bpm>=200)return!1;this.bpm+=this.bpmStep,this.playing!==null&&this.toggle(this.rhythm,this.index,!0)},loadYoutubeApi(){const e=document.createElement("script");e.src="https://www.youtube.com/iframe_api",this.$el.append(e),window.onYouTubeIframeAPIReady=()=>{this.youtubePlayer=new YT.Player("player",{with:"320",height:"240",events:{onReady:this.onYoutubePlayerReady,onError:this.onYoutubePlayerError,onStateChange:this.onYoutubePlayerStateChange}})}},loadSrcAudioElement(){if(!this.$refs.srcTrack)return setTimeout(()=>this.loadSrcAudioElement(),100);this.$refs.srcTrack.onchange=e=>{this.stop();const t=e.target.files[0];if(this.loadingTempo=!1,this.tempo=null,!t){this.srcTrack=null,this.strTrackTitle=null,this.srcTrackBuffer=null;return}this.strTrackTitle=t.name.replace(/_-/," "),this.reader.readAsArrayBuffer(t)}},calcBPM(){if(!this.srcTrackBuffer)return;this.stop(),this.tempo=null,this.loadingTempo=!0,this.audioCtx=new AudioContext;const e=this.audioCtx.createScriptProcessor(this.bufferSize,1,1),t=this.audioCtx.createGain();t.gain.value=0,t.connect(this.audioCtx.destination),e.connect(t),this.audioCtx.decodeAudioData(this.srcTrackBuffer.slice(0)).then(r=>{this.srcTrack=this.audioCtx.createBufferSource(),this.srcTrack.buffer=r,this.srcTrack.connect(e),this.srcTrack.connect(t),w().then(({Tempo:a})=>{const i=new a(e.bufferSize*4,e.bufferSize,this.audioCtx.sampleRate);e.onaudioprocess=s=>{let m=i.do(s.inputBuffer.getChannelData(0)),c=i.getBpm();m&&(this.tempo=parseInt(c))},this.srcTrack.start(10,0,5),this.srcTrack.onended=()=>{this.audioCtx.close(),this.loadingTempo=!1}})})},toggleAutoBPM(){this.tempo?this.tempo=null:this.calcBPM()},onYoutubePlayerReady(){this.youtubeReady=!0},onYoutubePlayerError(e){this.youtubeReady=!1},onYoutubePlayerStateChange(e){this.youtubeReady=e.data==5},pasteYoutubeLink(){this.youtubeReady=!1,navigator.clipboard.readText().then(e=>{e&&(this.youtubeLink=e,this.refreshYoutubeLink())})},refreshYoutubeLink(){var a,i;if(this.stop(),!this.youtubeLink)return;this.youtubeReady=!1;const e=new URL(this.youtubeLink),t=e.searchParams.get("v")??e.pathname.replace("/",""),r=parseInt(e.searchParams.get("t")??"0");(a=this.youtubePlayer)==null||a.cueVideoById(t,r),(i=this.youtubePlayer)==null||i.setVolume(50)}}},B=e=>(I("data-v-5c13fe4c"),e=e(),R(),e),U=B(()=>l("div",{id:"player"},null,-1)),N=B(()=>l("figure",null,null,-1)),z={type:"file",id:"srcTrack",ref:"srcTrack",accept:"audio/*,video/*"},G=["src"];function O(e,t,r,a,i,s){const m=u("v-select"),c=u("v-slider"),C=u("v-progress-linear"),h=u("v-btn"),P=u("v-icon"),S=u("v-text-field"),x=u("v-main"),A=_("ripple");return d(),y("main",null,[n(x,null,{default:b(()=>[U,l("section",null,[N,l("mark",{class:v({animating:i.playing!=null})},null,2)]),l("section",null,[l("header",null,[n(m,{modelValue:s.bpm,"onUpdate:modelValue":t[0]||(t[0]=o=>s.bpm=o),items:s.tempos,"item-title":"name","item-value":"bpm",label:e.$t("metronome.tempo"),disabled:i.loadingTempo||s.autoBPM},null,8,["modelValue","items","label","disabled"]),!i.loadingTempo&&!i.tempo?(d(),f(c,{key:0,"hide-details":"",modelValue:s.bpm,"onUpdate:modelValue":t[1]||(t[1]=o=>s.bpm=o),step:"5",max:"200","thumb-label":"always",color:"primary",onChange:t[2]||(t[2]=o=>s.toggle(i.rhythm,i.index,!0))},null,8,["modelValue"])):g("",!0),!i.loadingTempo&&i.tempo?(d(),f(c,{key:1,"hide-details":"",readonly:"",modelValue:i.tempo,"onUpdate:modelValue":t[3]||(t[3]=o=>i.tempo=o),step:"1",max:"250","thumb-label":"always",onChange:t[4]||(t[4]=o=>s.toggle(i.rhythm,i.index,!0))},null,8,["modelValue"])):g("",!0),i.loadingTempo?(d(),f(C,{key:2,indeterminate:""})):g("",!0)]),l("article",null,[n(h,{onClick:s.subtractBpm,ref:"subtractBpmButton",icon:"remove",size:"small",disabled:i.loadingTempo||s.autoBPM,title:e.$t("metronome.subtractStep",{n:s.bpmStep})},null,8,["onClick","disabled","title"]),n(m,{variant:"underlined",modelValue:s.bpmStep,"onUpdate:modelValue":t[5]||(t[5]=o=>s.bpmStep=o),items:s.tempos,"item-title":"bpm",disabled:i.loadingTempo||s.autoBPM,"item-value":"bpm"},null,8,["modelValue","items","disabled"]),n(h,{fab:"",small:"",onClick:s.addBpm,ref:"addBpmButton",icon:"add",size:"small",disabled:i.loadingTempo||s.autoBPM,title:e.$t("metronome.addStep",{n:s.bpmStep})},null,8,["onClick","disabled","title"])]),l("nav",null,[l("div",null,[l("input",z,null,512),M((d(),y("label",{for:"srcTrack",class:v(["v-btn v-btn--elevated v-btn--density-default v-btn--size-default v-btn--variant-elevated elevation-4",{"bg-accent":!!i.strTrackTitle,"v-btn--disabled":i.playing||i.loadingTempo}])},[l("span",null,k(i.strTrackTitle??e.$t("metronome.srcTrack")),1)],2)),[[A]]),n(h,{loading:i.loadingTempo,disabled:i.playing!=null||!i.strTrackTitle,onClick:t[6]||(t[6]=o=>s.toggleAutoBPM())},{default:b(()=>[n(P,null,{default:b(()=>[T(k(s.autoBPM?"pan_tool":"speed"),1)]),_:1}),T("Â "+k(s.autoBPM?e.$t("metronome.manualBpm"):e.$t("metronome.detectBpm")),1)]),_:1},8,["loading","disabled"])]),l("div",null,[n(S,{modelValue:i.youtubeLink,"onUpdate:modelValue":t[7]||(t[7]=o=>i.youtubeLink=o),label:"Youtube video","append-inner-icon":"content_paste","onClick:appendInner":t[8]||(t[8]=o=>s.pasteYoutubeLink()),onInput:t[9]||(t[9]=o=>s.refreshYoutubeLink())},null,8,["modelValue"])])]),l("footer",null,[(d(!0),y(L,null,D(i.buttons,(o,p)=>(d(),f(h,{key:p,onClick:F=>s.toggle(o.strokes,p),color:i.playing==p?"primary":null,class:"elevation-4",disabled:i.loadingTempo||!s.youtubeEnabled,title:e.$t("metronome.play",{n:`Numpad ${p+1}`})},{default:b(()=>[l("img",{src:`${o.icon}${s.darkTheme?"-dark":"-light"}.svg`},null,8,G)]),_:2},1032,["onClick","color","disabled","title"]))),128))])])]),_:1})])}const j=V(E,[["render",O],["__scopeId","data-v-5c13fe4c"]]);export{j as default};
